<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta charset="utf-8" />
    <link href="Content/bootstrap.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha_dev.js" integrity="sha256-f7uKv5jSZ00WFrbiC2joTv0Ib563JE+GqY7DIZuVa4Y=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha.js" integrity="sha256-cyY9tyQbycFc+9eOsamJ8K8wmBsMcsXgxS9nLLkqK+I=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/2.4.2/sha1.js" integrity="sha256-ibMriwe6cOMfwW99BUHikXiQ/5ss7ZK0hR/a/vJY5I8=" crossorigin="anonymous"></script>    
    
</head>
<body style="padding-top:20px">
    <script>
        window.fbAsyncInit = function () {
            FB.init({
                appId: '640502623345125',
                autoLogAppEvents: true,
                xfbml: true,
                version: 'v7.0'
            });
        };

    </script>
    <script async defer src="https://connect.facebook.net/en_US/sdk.js"></script>
    <div class="col-md-10 col-md-offset-1">
        <div class="well">
            <!--Table to capture username and password-->
            <table class="table table-bordered">
                <thead>
                    <tr class="success">
                        <th colspan="2">
                            Existing User Login
                            <a href="Register.html" class="btn btn-success pull-right">
                                Register
                            </a>
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>Usename</td>
                        <td>
                            <input type="text" id="txtUsername" placeholder="Username" />
                        </td>
                    </tr>
                    <tr>
                        <td>Password</td>
                        <td>
                            <input type="password" id="txtPassword"
                                   placeholder="Password" />
                        </td>
                    </tr>
                    <tr class="success">
                        <td colspan="2">
                            <input id="btnLogin" class="btn btn-success" type="button"
                                   value="Login" />
                        </td>
                    </tr>
                </tbody>
            </table>
            <table class="table table-bordered">
                <thead>
                    <tr class="success">
                        <th>
                            Social Logins
                        </th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>
                            <input type="button" id="btnFacebookLogin"
                                   value="Login with Facebook" class="btn btn-success" />
                            <input type="button" id="btnTwLogin"
                                   value="Login with Twitter" class="btn btn-success" />
                        </td>
                    </tr>
                </tbody>
            </table>
            <!--Bootstrap alert to display error message if the login fails-->
            <div id="divError" class="alert alert-danger collapse">
                <a id="linkClose" href="#" class="close">&times;</a>
                <div id="divErrorText"></div>
            </div>
        </div>
    </div>
    <input id="get" class="btn btn-success" type="button"
           value="Get" />
    <input id="getPhotos" class="btn btn-success" type="button"
           value="Get Photos" />
    <script src="Scripts/jquery-3.5.1.min.js"></script>

    <script type="text/javascript">
        $(document).ready(function () {

            $('#btnTwLogin').click(function () {
                twSignin()
            });
            $('#btnFacebookLogin').click(function () {
                alert("sdfsdf")
                FB.login(function (response) {
                    if (response.authResponse) {
                        localStorage.setItem("fb_access_token", response.authResponse.accessToken);
                        window.location.href = "Aggregator.html";
                        // Now you can redirect the user or do an AJAX request to
                        // a PHP script that grabs the signed request from the cookie.
                    } else {
                        alert('User cancelled login or did not fully authorize.');
                    }
                });
            });
            $('#get').click(function () {
                $.ajax({
                    // Post username, password & the grant type to /token
                    url: '/api/Facebook',
                    method: 'GET',
                    contentType: 'application/json',
                    data: {
                        id: 'EAAJGiKNXmeUBAPb7Ek09jMZA7b0WlOIQnjIksYLi1qZABbJvuyYFd89UfQPWZCTSl8nrBI3YJ4lIkfGFRLUX898cRqppzEpOoMCA78BS9yvjXLbJ8xGXOYhK6uufFqKhdr8Vc3PafHIJCYYUq4rQZAMtZCd3hSPvIPZC0wMRejHrYlKUZC6kHhQexfchpWZA2g2HwcLTKIK0owdu1BginBydT3tjKe6ScwOAI9MKiU0IxcZA1pruXJgag'
                    },
                    // When the request completes successfully, save the
                    // access token in the browser session storage and
                    // redirect the user to Data.html page. We do not have
                    // this page yet. So please add it to the
                    // EmployeeService project before running it
                    success: function (response) {
                        //alert("sdfg")
                        //console.log(response)
                        var obj = JSON.parse(response);
                        console.log(obj)
                        console.log(obj.data)
                        var l = obj.data.length
                        for (i = 0; i < l - 1; i++) {
                            console.log(obj.data[i].message)
                            //if (obj.posts.data[i].attachments.data[0] != null) {
                            //    console.log(obj.posts.data[i].attachments.data[0])
                            //}

                        }
                        //for (p in obj.posts.data) {
                        //    console.log(p.id)
                        //}
                        //console.log(obj.posts.data[0].id)

                        //sessionStorage.setItem("accessToken", response.access_token);
                        //window.location.href = "Data.html";
                    },
                    // Display errors if any in the Bootstrap alert <div>
                    error: function (jqXHR) {
                        alert("error")
                    }
                });
            });
            $('#getPhotos').click(function () {
                $.ajax({
                    // Post username, password & the grant type to /token
                    url: '/api/Photos',
                    method: 'GET',
                    contentType: 'application/json',
                    data: {
                        id: 'EAAJGiKNXmeUBAEwQUbBAcLudDkrLZAI7PapQ9D7v6DWrfMQDzoo9jWZARPLrZCQkXoeeGKh72JDSskuTEQ09ZBLFCpOs5MZCM2Q1S60Q9BY0NBHa0tvbbH9SwEZC1DzW01t578St4rUM6eccNZBJm85Bo8gRZC1oiQnhsZAwNvDJnJFqIcBUeBJUCfSbci67zOzNekeAuN7qel3NF78M5JZBCS2HwBjs9vjyhNtf5sMnJTzA5JRr2jUO7m'
                    },
                    // When the request completes successfully, save the
                    // access token in the browser session storage and
                    // redirect the user to Data.html page. We do not have
                    // this page yet. So please add it to the
                    // EmployeeService project before running it
                    success: function (response) {
                        //alert("sdfg")
                        //console.log(response)
                        var obj = JSON.parse(response);
                        console.log(obj)
                        console.log(obj.data)
                        var l = obj.data.length
                        for (i = 0; i < l - 1; i++) {
                            console.log(obj.data[i].picture)
                            //if (obj.posts.data[i].attachments.data[0] != null) {
                            //    console.log(obj.posts.data[i].attachments.data[0])
                            //}

                        }
                        //for (p in obj.posts.data) {
                        //    console.log(p.id)
                        //}
                        //console.log(obj.posts.data[0].id)

                        //sessionStorage.setItem("accessToken", response.access_token);
                        //window.location.href = "Data.html";
                    },
                    // Display errors if any in the Bootstrap alert <div>
                    error: function (jqXHR) {
                        alert("error")
                    }
                });
            });

            $('#linkClose').click(function () {
                $('#divError').hide('fade');
            });

            $('#btnFacebookLogin').click(function () {
                //window.location.href = "/api/Account/ExternalLogin?provider=Facebook&response_type=token&client_id=self&redirect_uri=http%3A%2F%2Flocalhost%3A60629%2FLogin.html&state=NaPt-0OOxevMrUuhFH7YsVDwlX4zUZDDsh8ONo4nndk1";
                FB.getLoginStatus(function (response) {
                    if (response.status === 'connected') {
                        var accessToken = response.authResponse.accessToken;
                        alert("got token")
                    }
                });
            });

            $('#btnLogin').click(function () {
                $.ajax({
                    // Post username, password & the grant type to /token
                    url: '/token',
                    method: 'POST',
                    contentType: 'application/json',
                    data: {
                        username: $('#txtUsername').val(),
                        password: $('#txtPassword').val(),
                        grant_type: 'password'
                    },
                    // When the request completes successfully, save the
                    // access token in the browser session storage and
                    // redirect the user to Data.html page. We do not have
                    // this page yet. So please add it to the
                    // EmployeeService project before running it
                    success: function (response) {
                        localStorage.setItem("accessToken", response.access_token);
                        alert("token is:" + response.access_token)
                        window.location.href = "Aggregator.html";
                    },
                    // Display errors if any in the Bootstrap alert <div>
                    error: function (jqXHR) {
                        $('#divErrorText').text(jqXHR.responseText);
                        $('#divError').show('fade');
                    }
                });
            });
        });
    </script>

    <script src="https://www.gstatic.com/firebasejs/7.15.0/firebase-app.js"></script>
    <script defer src="https://www.gstatic.com/firebasejs/7.15.0/firebase-auth.js"></script>
    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyDd-PVlgFvw2ToYZqJQ8x1TpBxn9D4Drx4",
            authDomain: "distributedhome-8b50c.firebaseapp.com",
            databaseURL: "https://distributedhome-8b50c.firebaseio.com",
            projectId: "distributedhome-8b50c",
            storageBucket: "distributedhome-8b50c.appspot.com",
            messagingSenderId: "1045191378985",
            appId: "1:1045191378985:web:55bdefa7911adbccfd3438"
        };
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
    </script>
    <script>
        function twSignin() {
            var provider = new firebase.auth.TwitterAuthProvider();
            firebase.auth().useDeviceLanguage();
            firebase.auth().signInWithPopup(provider).then(function (result) {
                // This gives you a the Twitter OAuth 1.0 Access Token and Secret.
                // You can use these server side with your app's credentials to access the Twitter API.
                var token = result.credential.accessToken;
                var secret = result.credential.secret;
                // The signed-in user info.
                var user = result.user;
                console.log(result)
                console.log(token)
                console.log(secret)
                $.ajax({
                    // Post username, password & the grant type to /token
                    url: 'api/TwitterTimeLine',
                    method: 'GET',
                    contentType: 'application/json',
                    data: {
                        //'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                        id: token,
                        token: secret

                        //id: 'screen_name="twitterdev", oauth_consumer_key="' + consumerKey + '", oauth_nonce="' + nonce + '", oauth_signature="' + signature + '", oauth_signature_method="HMAC-SHA1"' + ', oauth_timestamp="' + timestamp + '", oauth_token="' + accessToken + '", oauth_version="1.0"'
                        //id: 'twitterdev/' + consumerKey + '/' + nonce + '/' + signature + '/HMAC-SHA1' + '/' + timestamp + '/' + accessToken + '/1.0'

                        //'oauth_consumer_key': consumerKey,
                        //'oauth_nonce': nonce,
                        //'oauth_signature': signature,
                        //'oauth_signature_method': 'HMAC-SHA1',
                        //'oauth_timestamp': timestamp,
                        //'oauth_token': accessToken,
                        //'oauth_version': '1.0'

                    },
                    success: function (response) {
                        console.log(response)
                        var obj = JSON.parse(response);

                    },
                    // Display errors if any in the Bootstrap alert <div>
                    error: function (jqXHR) {
                        alert("error")
                    }
                });
                // ...
            }).catch(function (error) {
                // Handle Errors here.
                alert("sdgfsfdg")
                var errorCode = error.code;
                var errorMessage = error.message;
                // The email of the user's account used.
                var email = error.email;
                // The firebase.auth.AuthCredential type that was used.
                var credential = error.credential;
                // ...
            });
        }

        
            // return interpolated string
            /*
            $.ajax({
                // Post username, password & the grant type to /token
                url: 'api/TwitterTimeLine',
                method: 'GET',
                contentType: 'application/json',
                data: {
                    //'Authorization': 'Bearer ' + localStorage.getItem('accessToken')
                    id: 'oauth_consumer_key=' + consumerKey + '&oauth_nonce=' + nonce + '&oauth_signature=' + signature + '&oauth_signature_method=HMAC-SHA1' + '&oauth_timestamp=' + timestamp + '&oauth_token=' + accessToken + '&oauth_version=1.0',
                    //id: 'screen_name="twitterdev", oauth_consumer_key="' + consumerKey + '", oauth_nonce="' + nonce + '", oauth_signature="' + signature + '", oauth_signature_method="HMAC-SHA1"' + ', oauth_timestamp="' + timestamp + '", oauth_token="' + accessToken + '", oauth_version="1.0"'
                    //id: 'twitterdev/' + consumerKey + '/' + nonce + '/' + signature + '/HMAC-SHA1' + '/' + timestamp + '/' + accessToken + '/1.0'

                    //'oauth_consumer_key': consumerKey,
                    //'oauth_nonce': nonce,
                    //'oauth_signature': signature,
                    //'oauth_signature_method': 'HMAC-SHA1',
                    //'oauth_timestamp': timestamp,
                    //'oauth_token': accessToken,
                    //'oauth_version': '1.0'

                },
                success: function (response) {
                    console.log(response)
                    var obj = JSON.parse(response);
                    
                },
                // Display errors if any in the Bootstrap alert <div>
                error: function (jqXHR) {
                    alert("error")
                }
            });
            */

        
        function oAuthBaseString(method, url, params, key, token, timestamp, nonce) {
            return method
                + '&' + percentEncode(url)
                + '&' + percentEncode(genSortedParamStr(params, key, token, timestamp, nonce));
        };
        function oAuthSigningKey(consumer_secret, token_secret) {
            return consumer_secret + '&' + token_secret;
        };
        function oAuthSignature(base_string, signing_key) {
            var signature = hmac_sha1(base_string, signing_key);
            return percentEncode(signature);
        };
        function percentEncode(str) {
            return encodeURIComponent(str).replace(/[!*()']/g, (character) => {
                return '%' + character.charCodeAt(0).toString(16);
            });
        };
        //var jsSHA = require('jssha');
        function hmac_sha1(string, secret) {
            let shaObj = new jsSHA("SHA-1", "TEXT");
            shaObj.setHMACKey(secret, "TEXT");
            shaObj.update(string);
            let hmac = shaObj.getHMAC("B64");
            return hmac;
        };
        function mergeObjs(obj1, obj2) {
            for (var attr in obj2) {
                obj1[attr] = obj2[attr];
            }
            return obj1;
        };
        function genSortedParamStr(params, key, token, timestamp, nonce) {
            // Merge oauth params & request params to single object
            let paramObj = mergeObjs(
                {
                    oauth_consumer_key: key,
                    oauth_nonce: nonce,
                    oauth_signature_method: 'HMAC-SHA1',
                    oauth_timestamp: timestamp,
                    oauth_token: token,
                    oauth_version: '1.0'
                },
                params
            );
            // Sort alphabetically
            let paramObjKeys = Object.keys(paramObj);
            let len = paramObjKeys.length;
            paramObjKeys.sort();
            // Interpolate to string with format as key1=val1&key2=val2&...
            let paramStr = paramObjKeys[0] + '=' + paramObj[paramObjKeys[0]];
            for (var i = 1; i < len; i++) {
                paramStr += '&' + paramObjKeys[i] + '=' + percentEncode(decodeURIComponent(paramObj[paramObjKeys[i]]));
            }
            return paramStr;
        };
    </script>
</body>
</html>